<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia at 2015-05-11
 | Rendered using Apache Maven Fluido Skin 1.3.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20150511" />
    <meta http-equiv="Content-Language" content="en" />
    <title>Tutorial Command Query Responsibility Segregation - CQRS and REST</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.3.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />

      
    <script type="text/javascript" src="./js/apache-maven-fluido-1.3.0.min.js"></script>

    
            </head>
        <body class="topBarDisabled">
          
        
    
        <div class="container-fluid">
          <div id="banner">
        <div class="pull-left">
                                <div id="bannerLeft">
                                                                                                <img src="images/UniKnow-logo.jpg"  alt="UniKnow"/>
                </div>
                      </div>
        <div class="pull-right">              <div id="bannerRight">
                <h2>Tutorial Command Query Responsibility Segregation</h2>
                </div>
      </div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
                
                    
                  <li id="publishDate">Last Published: 2015-05-11</li>
                  <li class="divider">|</li> <li id="projectVersion">Version: 0.1.9-SNAPSHOT</li>
                      
                
                    
      
                            </ul>
      </div>

            
      <div class="row-fluid">
        <div id="leftColumn" class="span3">
          <div class="well sidebar-nav">
                
                    
                <ul class="nav nav-list">
                    <li class="nav-header">Parent Project</li>
                                
      <li>
    
                          <a href="../index.html" title="AgileDev parent POM">
          <i class="none"></i>
        AgileDev parent POM</a>
            </li>
                              <li class="nav-header">CQRS Reference</li>
                                
      <li>
    
                          <a href="introducing_cqrs.html" title="Introducing CQRS">
          <i class="none"></i>
        Introducing CQRS</a>
            </li>
            </ul>
                
                    
                
          <hr class="divider" />

           <div id="poweredBy">
                            <div class="clear"></div>
                            <div class="clear"></div>
                            <div class="clear"></div>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                  </div>
          </div>
        </div>
        
                
        <div id="bodyColumn"  class="span9" >
                                  
            <h1>CQRS and REST</h1>
<p>This article demonstrates an approach for building a RESTful API on top of a CQRS based system.</p>
<div class="section">
<h2>CQRS prototype.<a name="CQRS_prototype."></a></h2>
<p>Within this article we use a simplistic inventory management model. You can create a new inventory items, rename, or de-activate them. De-activated items cannot be viewed anymore but lists of all active items can be retrieved and we can drill down into the details of each item. You can also check-on or check-out stock against these inventory items specifying the number of stock added or removed. In other words, we build up stock and then start using it.</p>
<p>Viewing the list of items or details of an item is achieved through queries which are synchronous. Any changes to the state are achieved using commands.</p>
<p>Commands and queries are stored separately and are each handled by completely different parts of the system.</p>
<p>TODO: Create CQRS prototype.</p></div>
<div class="section">
<h2>Creating a REST API<a name="Creating_a_REST_API"></a></h2>
<p>The most important responsibility of the REST API is to model the underlying domain as resources and expose it with HTTP semantics. During this process we create a public domain which is composed of resources and input/output messages.</p>
<p>In general you should NOT expose the underlying domain because you want to be able to change your domain objects without having to change the public facing API. Same thing the other way around, if changes are required to the public API, you don&#x2019;t want to change your domain as well.</p>
<div class="section">
<h3>Resources<a name="Resources"></a></h3>
<p>We will expose the domain via single resource at <tt>api/InventoryItem</tt>. Each inventory item will be sitting at <tt>api/InventoryItem/{id}</tt>.</p>

<table border="0" class="table table-striped">
  <thead>
    
<tr class="a">
      
<th>Method</th>
      
<th>URL</th>
      
<th>Payload</th>
      
<th>In/Out</th>
      
<th>Expected result</th>
    </tr>
  </thead>
  <tbody>
    
<tr class="b">
      
<td><tt>POST</tt></td>
      
<td><tt>/api/InventoryItem</tt></td>
      
<td><tt>CreateInventoryItem</tt></td>
      
<td>IN</td>
      
<td>Create new inventory item</td>
    </tr>
    
<tr class="a">
      
<td><tt>GET</tt></td>
      
<td><tt>/api/InventoryItem</tt></td>
      
<td><tt>InventoryItemCollection</tt></td>
      
<td>OUT</td>
      
<td>Returns all inventory items</td>
    </tr>
    
<tr class="b">
      
<td><tt>POST</tt></td>
      
<td><tt>/api/InventoryItem/{id}</tt></td>
      
<td><tt>RenameInventoryItem</tt></td>
      
<td>IN</td>
      
<td>Renames an existing inventory item</td>
    </tr>
    
<tr class="a">
      
<td><tt>DELETE</tt></td>
      
<td><tt>/api/InventoryItem/{id}</tt></td>
      
<td><tt>DeactivateInventoryItem</tt></td>
      
<td>IN</td>
      
<td>De-activates existing inventory item</td>
    </tr>
    
<tr class="b">
      
<td><tt>POST</tt></td>
      
<td><tt>/api/InventoryItem/{id}</tt></td>
      
<td><tt>RemoveItemsFromInventory</tt></td>
      
<td>IN</td>
      
<td>Removes a number of items from the stock</td>
    </tr>
    
<tr class="a">
      
<td><tt>POST</tt></td>
      
<td><tt>/api/InventoryItem/{id}</tt></td>
      
<td><tt>AddItemsToInventory</tt></td>
      
<td>IN</td>
      
<td>Adds a number of items to the stock</td>
    </tr>
    
<tr class="b">
      
<td><tt>GET</tt></td>
      
<td><tt>/api/InventoryItem/{id}</tt></td>
      
<td><tt>InventoryItemDetail</tt></td>
      
<td>OUT</td>
      
<td>Returns inventory item details</td>
    </tr>
  </tbody>
</table>
<p>We have 2 queries <tt>GetInventoryItems</tt> and <tt>GetInventoryItemDetails</tt>. They are exposed with <tt>GET</tt> methods at <tt>/api/InventoryItem/{id}</tt>.</p>
<p><tt>GetInventoryItems</tt> retrieves a list of names and ids as JSON or XML depending on the <tt>accept</tt> header. The output message is implemented by the <tt>InventoryItemCollection</tt>. <tt>GetInventoryItemDetails</tt> returns details of a single item. This includes id, name, and currentCount.</p>
<p>Queries naturally map to <tt>GET</tt> while commands need to be mapped to <tt>POST</tt>, <tt>PUT</tt>, <tt>DELETE</tt>. One common approach is using RPC-style resources, for example <tt>/api/InventoryItem/{id}/rename</tt>. While this might be tempting, it is against REST resource oriented presentation. The command in the payload of the HTTP message should be enough to express any arbitrary action. However, relying on the body of the message has problems of its own since the body is usually delivered as a stream and buffering the body in its entirety before identifying the action is not always possible, nor wise. Here we present an approach based on level 4 (domain model) of <a class="externalLink" href="http://byterot.blogspot.co.uk/2012/12/5-levels-of-media-type-rest-csds.html">5LMT</a> where the command type is presented as a parameter of the <tt>contentType</tt> header.</p>
<p>This is required to channel the request to the appropriate handler on the service.</p>
<p>TODO: * Include location header. * Include Content-Type header <a class="externalLink" href="http://byterot.blogspot.co.uk/2012/12/5-levels-of-media-type-rest-csds.html">Five levels of Media Type</a> (5LMT) * Include <tt>if-unmodified-since</tt>, <tt>if-match</tt> and <tt>ETag</tt>.</p></div></div>
<div class="section">
<h2>Resource<a name="Resource"></a></h2>

<ul>
  
<li><a class="externalLink" href="http://www.infoq.com/articles/rest-api-on-cqrs">Exposing CQRS through a RESTful API</a></li>
  
<li><a class="externalLink" href="https://github.com/gregoryyoung/m-r">m-r example in c#</a></li>
</ul></div>
                  </div>
            </div>
          </div>

    <hr/>

    <footer>
            <div class="container-fluid">
              <div class="row span12">Copyright &copy;                    2015
                        <a href="http://www.uniknow.org">UniKnow</a>.
            All Rights Reserved.      
                    
      </div>

        
        
                </div>
    </footer>
  <div id="searchbox">
  <iframe id="searchbox-frame" src=".//searchbox.html" width="100%" style="border: 0" height="100%">
  </iframe>
</div>
<!-- Search box courtesy of Maven Site Indexer -->
</body>
</html>
